*Определение.* $V$-функция:
$$V^{\pi}(s) = \mathbb{E}_{\mathcal{T}\sim\pi | s_0 = s}R(\mathcal{T})$$
*Определение.* $Q$-функция:
$$Q^{\pi}(s, a) = \mathbb{E}_{\mathcal{T}\sim\pi | s_0 = s, a_0 = a}R(\mathcal{T})$$
# Взаимосвязь V и Q функций
$QV$-уравнение:
$$Q^\pi(s, a) = r(s, a) + \gamma \mathbb{E}_\hat{s}V^\pi(\hat s)$$
$VQ$-уравнение:
$$V^\pi(s) = \mathbb{E}_{a \sim \pi(a, s)}Q^\pi(s, a)$$
$QQ$-уравнение:
$$
	\begin{aligned}
	Q^\pi(s, a) &= r(s, a) + \gamma \mathbb{E}_{\hat s} V^\pi(\hat s)=\\
	&= r(s, a) + \gamma \mathbb{E}_{\hat s} \mathbb{E}_{\hat a}Q^\pi(\hat s, \hat a)
	\end{aligned}
$$
$VV$-уравнение:
$$
\begin{aligned}
	V^{\pi}(s) & = \mathbb{E}_{\mathcal{T}\sim\pi | s_0 = s}R(\mathcal{T}) = \mathbb{E}_{\mathcal{T}\sim\pi | s_t = s}R(\mathcal{T_{t:}}) =\\
	& = \mathbb{E}_{a_t} \left[ r(s_t, a_t) + \gamma \mathbb{E}_{s_{t+1}}\mathbb{E}_{\mathcal{T}\sim\pi|s_{t+1}} R(\mathcal{T}_{t+1:}) \right] = \\
	&= \mathbb{E}_{a_t} \left[ r(s_t, a_t) + \gamma \mathbb{E}_{s'}V(s') \right] = \\
	&= \mathbb{E}_{a} \left[ r(s, a) + \gamma \mathbb{E}_{s'}V(s') \right]
\end{aligned}
$$
# Оператор Беллмана
Оператор Беллмана для $V$-функции:
$$\mathcal{B}V(s) = \mathbb{E}_{a\sim\pi(*|s)}[r(s, a) + \gamma \mathbb{E}_{s'}V(s')]$$
Оператор Беллмана для $Q$-функции:
$$\mathcal{B}Q(s, a) = r(s, a) + \gamma \mathbb{E}_{s'}\mathbb{E}_{a'}Q(s', a')$$
# Оператор оптимальности Беллмана
Оператор оптимальности Беллмана для $V$-функции:
$$\mathcal{B}V(s) = \max_a[r(s, a) + \gamma \mathbb{E}_{s'}V(s')]$$
Оператор оптимальности Беллмана для $Q$-функции:
$$\mathcal{B}Q(s, a) = r(s, a) + \gamma \mathbb{E}_{s'}\max_{a'}Q(s', a')]$$

# Принцип оптимальности Беллмана
*Определение.* Оптимальная политика:
Политику $\pi^*$ назовем оптимальной, если
$$\forall \pi, s: V^{\pi^*}(s, a) \ge V^\pi(s, a)$$
*Определение*. Оптимальная V-функция:
$$V^*(s) = \max_\pi V^\pi(s)$$
*Определение*. Оптимальная Q-функция:
$$Q^*(s, a) = \max_\pi Q^\pi(s, a)$$
*Определение.* Жадная политика:
$$\pi(s) = \arg\max_a Q(s, a)$$

Принцип оптимальности Беллмана заключается в том, жадный выбор действия является оптимальным при условии дальнейшей оптимальности действий.